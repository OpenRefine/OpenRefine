
package org.openrefine.wikibase.utils;

import java.io.IOException;
import java.util.Arrays;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Map;
import java.util.Set;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import okhttp3.OkHttpClient;
import okhttp3.Request;
import okhttp3.Response;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * A store for the allowed language codes for terms and monolingual text values in Wikibase.
 * <p>
 * The store holds codes for two contexts: <em>term</em> (labels, descriptions, aliases) and
 * <em>monolingual text</em> (claim values). Term allows fewer codes than monolingual text.
 * The API endpoint is passed in by callers; there is no hardcoded base URL, so this works for
 * any Wikibase instance.
 * </p>
 * <p>
 * The static default lists ({@link #DEFAULT_TERM_LANGUAGE_CODES} and {@link #DEFAULT_LANGUAGE_CODES}) are used only
 * as fallbacks when the endpoint is null or the API request fails. They apply to Wikidata only.
 * </p>
 * <p>
 * Queries to update the default lists (Wikidata):
 * </p>
 * <ul>
 *   <li>Term: curl "https://www.wikidata.org/w/api.php?action=query&amp;meta=wbcontentlanguages&amp;wbclprop=code&amp;wbclcontext=term&amp;format=json" | jq ".query.wbcontentlanguages[].code" | sed -e "s/$/,/"</li>
 *   <li>Monolingual text: curl "https://www.wikidata.org/w/api.php?action=query&amp;meta=wbcontentlanguages&amp;wbclprop=code&amp;wbclcontext=monolingualtext&amp;format=json" | jq ".query.wbcontentlanguages[].code" | sed -e "s/$/,/"</li>
 * </ul>
 *
 * @author Antonin Delpeuch
 */
public class LanguageCodeStore {

    private static final Logger logger = LoggerFactory.getLogger(LanguageCodeStore.class);

    /**
     * Wikibase content language context: term (labels/descriptions/aliases) vs monolingual text (claim values).
     * Term allows fewer codes than monolingual text.
     */
    public enum LanguageCodeContext {
        TERM,
        MONOLINGUALTEXT
    }

    /**
     * Key: API endpoint. Value: map from context to set of language codes.
     */
    private static Map<String, Map<LanguageCodeContext, Set<String>>> apiEndpointToLangCodes = new HashMap<>();

    /**
     * Returns language codes for monolingual text. For backward compatibility.
     * Prefer {@link #getLanguageCodes(String, LanguageCodeContext)} when context is known.
     */
    public static Set<String> getLanguageCodes(String mediaWikiApiEndpoint) {
        return getLanguageCodes(mediaWikiApiEndpoint, LanguageCodeContext.MONOLINGUALTEXT);
    }

    /**
     * Returns the set of language codes allowed for the given context (term or monolingual text)
     * for the given Wikibase API endpoint. Uses cached result when available; on fetch error
     * returns the default list for that context (Wikidata fallback only).
     */
    public static Set<String> getLanguageCodes(String mediaWikiApiEndpoint, LanguageCodeContext context) {
        if (mediaWikiApiEndpoint == null) {
            return getDefaultLanguageCodes(context);
        }
        apiEndpointToLangCodes.putIfAbsent(mediaWikiApiEndpoint, new HashMap<>());
        Map<LanguageCodeContext, Set<String>> byContext = apiEndpointToLangCodes.get(mediaWikiApiEndpoint);
        if (byContext.containsKey(context)) {
            return byContext.get(context);
        }
        try {
            Set<String> langCodes = fetchLangCodes(mediaWikiApiEndpoint, context);
            byContext.put(context, langCodes);
            return langCodes;
        } catch (IOException e) {
            logger.error("An error occurred when fetching language codes from: "
                    + mediaWikiApiEndpoint + " (context=" + context + "), fall back to the default language codes", e);
            Set<String> fallback = getDefaultLanguageCodes(context);
            byContext.put(context, fallback);
            return fallback;
        }
    }

    private static Set<String> getDefaultLanguageCodes(LanguageCodeContext context) {
        return context == LanguageCodeContext.TERM ? DEFAULT_TERM_LANGUAGE_CODES : DEFAULT_LANGUAGE_CODES;
    }

    private static Set<String> fetchLangCodes(String mediaWikiApiEndpoint, LanguageCodeContext context)
            throws IOException {
        String wbclcontext = (context == LanguageCodeContext.TERM) ? "term" : "monolingualtext";
        String url = mediaWikiApiEndpoint
                + "?action=query&meta=wbcontentlanguages&wbclprop=code&wbclcontext=" + wbclcontext + "&format=json";
        OkHttpClient client = HttpClient.getClient();
        Request request = new Request.Builder().url(url).build();
        Response response = client.newCall(request).execute();
        if (!response.isSuccessful()) {
            throw new IOException("Failed to fetch Wikibase language codes. HTTP Response code: " + response.code());
        }
        JsonNode jsonNode = new ObjectMapper().readTree(response.body().string());
        JsonNode languages = jsonNode.path("query").path("wbcontentlanguages");
        Set<String> supportedLangCodes = new HashSet<>();
        for (JsonNode language : languages) {
            supportedLangCodes.add(language.path("code").textValue());
        }
        return supportedLangCodes;
    }

    /**
     * Fallback language codes for term context (labels, descriptions, aliases).
     * Used only when API fetch fails; Wikidata-only. Update with wbclcontext=term.
     */
    private static Set<String> DEFAULT_TERM_LANGUAGE_CODES = new HashSet<>(Arrays.asList(
            "aa",
            "aae",
            "ab",
            "abr",
            "abs",
            "ace",
            "acf",
            "acm",
            "ady",
            "ady-cyrl",
            "aeb",
            "aeb-arab",
            "aeb-latn",
            "af",
            "agq",
            "aig",
            "ak",
            "aln",
            "als",
            "alt",
            "am",
            "ami",
            "an",
            "ang",
            "ann",
            "anp",
            "apc",
            "ar",
            "arc",
            "arn",
            "arq",
            "ary",
            "arz",
            "as",
            "ase",
            "ast",
            "atj",
            "av",
            "avk",
            "awa",
            "ay",
            "az",
            "azb",
            "ba",
            "bag",
            "ban",
            "ban-bali",
            "bar",
            "bas",
            "bat-smg",
            "bax",
            "bbc",
            "bbc-latn",
            "bbj",
            "bcc",
            "bci",
            "bcl",
            "bdr",
            "be",
            "be-tarask",
            "be-x-old",
            "bew",
            "bfd",
            "bfw",
            "bg",
            "bgc",
            "bgn",
            "bh",
            "bho",
            "bi",
            "bjn",
            "bkc",
            "bkh",
            "bkm",
            "blk",
            "bm",
            "bn",
            "bo",
            "bol",
            "bpy",
            "bqi",
            "bqz",
            "br",
            "brh",
            "bs",
            "btm",
            "bto",
            "bug",
            "bug-bugi",
            "bxr",
            "byv",
            "ca",
            "cak",
            "cal",
            "cbk-zam",
            "ccp",
            "cdo",
            "cdo-hant",
            "cdo-latn",
            "ce",
            "ceb",
            "ch",
            "chn",
            "cho",
            "chr",
            "chy",
            "ckb",
            "cnh",
            "co",
            "cop",
            "cps",
            "cpx",
            "cpx-hans",
            "cpx-hant",
            "cpx-latn",
            "cr",
            "crh",
            "crh-cyrl",
            "crh-latn",
            "crh-ro",
            "cs",
            "csb",
            "cu",
            "cv",
            "cy",
            "da",
            "dag",
            "de",
            "de-at",
            "de-ch",
            "de-formal",
            "dga",
            "din",
            "diq",
            "dlg",
            "dsb",
            "dso",
            "dtp",
            "dty",
            "dua",
            "dv",
            "dz",
            "ee",
            "efi",
            "egl",
            "el",
            "eml",
            "en",
            "en-ca",
            "en-gb",
            "en-us",
            "eo",
            "es",
            "es-419",
            "es-formal",
            "et",
            "eto",
            "etu",
            "eu",
            "ewo",
            "ext",
            "fa",
            "fat",
            "ff",
            "fi",
            "fit",
            "fiu-vro",
            "fj",
            "fkv",
            "fmp",
            "fo",
            "fon",
            "fr",
            "frc",
            "frp",
            "frr",
            "fur",
            "fvr",
            "fy",
            "ga",
            "gaa",
            "gag",
            "gan",
            "gan-hans",
            "gan-hant",
            "gcf",
            "gcr",
            "gd",
            "gju-arab",
            "gju-deva",
            "gl",
            "gld",
            "glk",
            "gn",
            "gom",
            "gom-deva",
            "gom-latn",
            "gor",
            "got",
            "gpe",
            "grc",
            "gsw",
            "gu",
            "guc",
            "gur",
            "guw",
            "gv",
            "gya",
            "ha",
            "hak",
            "hak-hans",
            "hak-hant",
            "hak-latn",
            "haw",
            "he",
            "hi",
            "hif",
            "hif-latn",
            "hil",
            "hke",
            "hno",
            "ho",
            "hoc",
            "hoc-latn",
            "hr",
            "hrx",
            "hsb",
            "hsn",
            "ht",
            "hu",
            "hu-formal",
            "hy",
            "hyw",
            "hz",
            "ia",
            "iba",
            "ibb",
            "id",
            "ie",
            "ig",
            "igl",
            "ii",
            "ik",
            "ike-cans",
            "ike-latn",
            "ilo",
            "inh",
            "io",
            "is",
            "isu",
            "isv-cyrl",
            "isv-latn",
            "it",
            "iu",
            "ja",
            "jam",
            "jbo",
            "jut",
            "jv",
            "jv-java",
            "ka",
            "kaa",
            "kab",
            "kai",
            "kaj",
            "kbd",
            "kbd-cyrl",
            "kbp",
            "kcg",
            "kea",
            "ker",
            "kg",
            "kge",
            "kgg",
            "khw",
            "ki",
            "kiu",
            "kj",
            "kjh",
            "kjp",
            "kk",
            "kk-arab",
            "kk-cn",
            "kk-cyrl",
            "kk-kz",
            "kk-latn",
            "kk-tr",
            "kl",
            "km",
            "kn",
            "knc",
            "ko",
            "ko-kp",
            "koi",
            "kr",
            "krc",
            "kri",
            "krj",
            "krl",
            "ks",
            "ks-arab",
            "ks-deva",
            "ksf",
            "ksh",
            "ksw",
            "ku",
            "ku-arab",
            "ku-latn",
            "kum",
            "kus",
            "kv",
            "kw",
            "ky",
            "la",
            "lad",
            "lb",
            "lbe",
            "lem",
            "lez",
            "lfn",
            "lg",
            "li",
            "lij",
            "liv",
            "ljp",
            "lki",
            "lld",
            "lmo",
            "ln",
            "lns",
            "lo",
            "loz",
            "lrc",
            "lt",
            "ltg",
            "lua",
            "lus",
            "luz",
            "lv",
            "lzh",
            "lzz",
            "mad",
            "mag",
            "mai",
            "map-bms",
            "mcn",
            "mcp",
            "mdf",
            "mg",
            "mh",
            "mhr",
            "mi",
            "min",
            "mk",
            "ml",
            "mn",
            "mnc",
            "mnc-latn",
            "mnc-mong",
            "mni",
            "mnw",
            "mo",
            "mos",
            "mr",
            "mrh",
            "mrj",
            "ms",
            "ms-arab",
            "mt",
            "mua",
            "mui",
            "mus",
            "mwl",
            "my",
            "myv",
            "mzn",
            "na",
            "nah",
            "nan",
            "nan-hani",
            "nan-hant",
            "nan-latn-pehoeji",
            "nan-latn-tailo",
            "nap",
            "nb",
            "nds",
            "nds-nl",
            "ne",
            "new",
            "ng",
            "nge",
            "nia",
            "nit",
            "niu",
            "nl",
            "nl-informal",
            "nla",
            "nmg",
            "nmz",
            "nn",
            "nnh",
            "nnz",
            "no",
            "nod",
            "nog",
            "nov",
            "nqo",
            "nr",
            "nrm",
            "nso",
            "nup",
            "nv",
            "ny",
            "nyn",
            "nyo",
            "nys",
            "oc",
            "ojb",
            "olo",
            "om",
            "or",
            "os",
            "osa-latn",
            "ota",
            "pa",
            "pag",
            "pam",
            "pap",
            "pap-aw",
            "pcd",
            "pcm",
            "pdc",
            "pdt",
            "pfl",
            "pi",
            "pih",
            "pl",
            "pms",
            "pnb",
            "pnt",
            "ppl",
            "prg",
            "ps",
            "pt",
            "pt-br",
            "pwn",
            "qu",
            "quc",
            "qug",
            "rgn",
            "rif",
            "rki",
            "rm",
            "rmc",
            "rmf",
            "rmy",
            "rn",
            "ro",
            "roa-rup",
            "roa-tara",
            "rsk",
            "ru",
            "rue",
            "rup",
            "ruq",
            "ruq-cyrl",
            "ruq-latn",
            "rut",
            "rw",
            "rwr",
            "ryu",
            "sa",
            "sah",
            "sas",
            "sat",
            "sc",
            "scn",
            "sco",
            "sd",
            "sdc",
            "sdh",
            "se",
            "se-fi",
            "se-no",
            "se-se",
            "sei",
            "ses",
            "sg",
            "sgs",
            "sh",
            "sh-cyrl",
            "sh-latn",
            "shi",
            "shi-latn",
            "shi-tfng",
            "shn",
            "shy",
            "shy-latn",
            "si",
            "simple",
            "sjd",
            "sje",
            "sju",
            "sk",
            "skr",
            "skr-arab",
            "sl",
            "sli",
            "sm",
            "sma",
            "smj",
            "smn",
            "sms",
            "sn",
            "so",
            "sq",
            "sr",
            "sr-ec",
            "sr-el",
            "srn",
            "sro",
            "srq",
            "ss",
            "st",
            "stq",
            "sty",
            "su",
            "sv",
            "sw",
            "syl",
            "szl",
            "szy",
            "ta",
            "tay",
            "tcy",
            "tdd",
            "te",
            "tet",
            "tg",
            "tg-cyrl",
            "tg-latn",
            "th",
            "thq",
            "ti",
            "tig",
            "tk",
            "tl",
            "tly",
            "tly-cyrl",
            "tn",
            "to",
            "tok",
            "tpi",
            "tpv",
            "tr",
            "tru",
            "trv",
            "ts",
            "tt",
            "tt-cyrl",
            "tt-latn",
            "ttj",
            "tum",
            "tvu",
            "tw",
            "ty",
            "tyv",
            "tzm",
            "udm",
            "ug",
            "ug-arab",
            "ug-latn",
            "uk",
            "ur",
            "uz",
            "uz-cyrl",
            "uz-latn",
            "ve",
            "vec",
            "vep",
            "vi",
            "vls",
            "vmf",
            "vmw",
            "vo",
            "vot",
            "vro",
            "vut",
            "wa",
            "wal",
            "war",
            "wes",
            "wls",
            "wlx",
            "wo",
            "wuu",
            "wuu-hans",
            "wuu-hant",
            "wya",
            "xal",
            "xh",
            "xmf",
            "xsy",
            "yas",
            "yat",
            "yav",
            "ybb",
            "yi",
            "yo",
            "yrl",
            "yua",
            "yue",
            "yue-hans",
            "yue-hant",
            "za",
            "zea",
            "zgh",
            "zgh-latn",
            "zh",
            "zh-classical",
            "zh-cn",
            "zh-hans",
            "zh-hant",
            "zh-hk",
            "zh-min-nan",
            "zh-mo",
            "zh-my",
            "zh-sg",
            "zh-tw",
            "zh-yue",
            "zu",
            "mul"));

    private static Set<String> DEFAULT_LANGUAGE_CODES = new HashSet<>(Arrays.asList(
            "aa",
            "ab",
            "abs",
            "ace",
            "ady",
            "ady-cyrl",
            "aeb",
            "aeb-arab",
            "aeb-latn",
            "af",
            "ak",
            "aln",
            "als",
            "am",
            "an",
            "ang",
            "anp",
            "ar",
            "arc",
            "arn",
            "arq",
            "ary",
            "arz",
            "as",
            "ase",
            "ast",
            "atj",
            "av",
            "avk",
            "awa",
            "ay",
            "az",
            "azb",
            "ba",
            "ban",
            "bar",
            "bbc",
            "bbc-latn",
            "bcc",
            "bcl",
            "be",
            "be-tarask",
            "bg",
            "bgn",
            "bh",
            "bho",
            "bi",
            "bjn",
            "bm",
            "bn",
            "bo",
            "bpy",
            "bqi",
            "br",
            "brh",
            "bs",
            "btm",
            "bto",
            "bug",
            "bxr",
            "ca",
            "cbk-zam",
            "cdo",
            "ce",
            "ceb",
            "ch",
            "cho",
            "chr",
            "chy",
            "ckb",
            "co",
            "cps",
            "cr",
            "crh",
            "crh-cyrl",
            "crh-latn",
            "cs",
            "csb",
            "cu",
            "cv",
            "cy",
            "da",
            "de",
            "de-at",
            "de-ch",
            "din",
            "diq",
            "dsb",
            "dtp",
            "dty",
            "dv",
            "dz",
            "ee",
            "egl",
            "el",
            "eml",
            "en",
            "en-ca",
            "en-gb",
            "eo",
            "es",
            "es-419",
            "et",
            "eu",
            "ext",
            "fa",
            "ff",
            "fi",
            "fit",
            "fj",
            "fo",
            "fr",
            "frc",
            "frp",
            "frr",
            "fur",
            "fy",
            "ga",
            "gag",
            "gan",
            "gan-hans",
            "gan-hant",
            "gcr",
            "gd",
            "gl",
            "glk",
            "gn",
            "gom",
            "gom-deva",
            "gom-latn",
            "gor",
            "got",
            "grc",
            "gsw",
            "gu",
            "gv",
            "ha",
            "hak",
            "haw",
            "he",
            "hi",
            "hif",
            "hif-latn",
            "hil",
            "ho",
            "hr",
            "hrx",
            "hsb",
            "ht",
            "hu",
            "hy",
            "hyw",
            "hz",
            "ia",
            "id",
            "ie",
            "ig",
            "ii",
            "ik",
            "ike-cans",
            "ike-latn",
            "ilo",
            "inh",
            "io",
            "is",
            "it",
            "iu",
            "ja",
            "jam",
            "jbo",
            "jut",
            "jv",
            "ka",
            "kaa",
            "kab",
            "kbd",
            "kbd-cyrl",
            "kbp",
            "kea",
            "kg",
            "khw",
            "ki",
            "kiu",
            "kj",
            "kjp",
            "kk",
            "kk-arab",
            "kk-cn",
            "kk-cyrl",
            "kk-kz",
            "kk-latn",
            "kk-tr",
            "kl",
            "km",
            "kn",
            "ko",
            "ko-kp",
            "koi",
            "kr",
            "krc",
            "kri",
            "krj",
            "krl",
            "ks",
            "ks-arab",
            "ks-deva",
            "ksh",
            "ku",
            "ku-arab",
            "ku-latn",
            "kum",
            "kv",
            "kw",
            "ky",
            "la",
            "lad",
            "lb",
            "lbe",
            "lez",
            "lfn",
            "lg",
            "li",
            "lij",
            "liv",
            "lki",
            "lmo",
            "ln",
            "lo",
            "loz",
            "lrc",
            "lt",
            "ltg",
            "lus",
            "luz",
            "lv",
            "lzh",
            "lzz",
            "mai",
            "map-bms",
            "mdf",
            "mg",
            "mh",
            "mhr",
            "mi",
            "min",
            "mk",
            "ml",
            "mn",
            "mni",
            "mnw",
            "mo",
            "mr",
            "mrj",
            "ms",
            "mt",
            "mus",
            "mwl",
            "my",
            "myv",
            "mzn",
            "na",
            "nah",
            "nan",
            "nap",
            "nb",
            "nds",
            "nds-nl",
            "ne",
            "new",
            "ng",
            "niu",
            "nl",
            "nn",
            "no",
            "nod",
            "nov",
            "nqo",
            "nrm",
            "nso",
            "nv",
            "ny",
            "nys",
            "oc",
            "olo",
            "om",
            "or",
            "os",
            "ota",
            "pa",
            "pag",
            "pam",
            "pap",
            "pcd",
            "pdc",
            "pdt",
            "pfl",
            "pi",
            "pih",
            "pl",
            "pms",
            "pnb",
            "pnt",
            "prg",
            "ps",
            "pt",
            "pt-br",
            "qu",
            "qug",
            "rgn",
            "rif",
            "rm",
            "rmy",
            "rn",
            "ro",
            "roa-tara",
            "ru",
            "rue",
            "rup",
            "ruq",
            "ruq-cyrl",
            "ruq-latn",
            "rw",
            "rwr",
            "sa",
            "sah",
            "sat",
            "sc",
            "scn",
            "sco",
            "sd",
            "sdc",
            "sdh",
            "se",
            "sei",
            "ses",
            "sg",
            "sgs",
            "sh",
            "shi",
            "shi-latn",
            "shi-tfng",
            "shn",
            "shy-latn",
            "si",
            "sje",
            "sk",
            "skr",
            "skr-arab",
            "sl",
            "sli",
            "sm",
            "sma",
            "smj",
            "smn",
            "sms",
            "sn",
            "so",
            "sq",
            "sr",
            "sr-ec",
            "sr-el",
            "srn",
            "srq",
            "ss",
            "st",
            "stq",
            "sty",
            "su",
            "sv",
            "sw",
            "szl",
            "ta",
            "tay",
            "tcy",
            "te",
            "tet",
            "tg",
            "tg-cyrl",
            "tg-latn",
            "th",
            "ti",
            "tk",
            "tl",
            "tly",
            "tn",
            "to",
            "tpi",
            "tr",
            "tru",
            "ts",
            "tt",
            "tt-cyrl",
            "tt-latn",
            "tum",
            "tw",
            "ty",
            "tyv",
            "tzm",
            "udm",
            "ug",
            "ug-arab",
            "ug-latn",
            "uk",
            "ur",
            "uz",
            "uz-cyrl",
            "uz-latn",
            "ve",
            "vec",
            "vep",
            "vi",
            "vls",
            "vmf",
            "vo",
            "vot",
            "vro",
            "wa",
            "war",
            "wo",
            "wuu",
            "xal",
            "xh",
            "xmf",
            "xsy",
            "yi",
            "yo",
            "yue",
            "za",
            "zea",
            "zgh",
            "zh",
            "zh-cn",
            "zh-hans",
            "zh-hant",
            "zh-hk",
            "zh-mo",
            "zh-my",
            "zh-sg",
            "zh-tw",
            "zu",
            "und",
            "mis",
            "mul",
            "zxx",
            "abe",
            "abq",
            "ami",
            "bnn",
            "brx",
            "chn",
            "cnr",
            "cop",
            "el-cy",
            "ett",
            "eya",
            "fkv",
            "fos",
            "fr-ca",
            "frm",
            "fro",
            "fuf",
            "gez",
            "gmy",
            "hai",
            "haz",
            "hbo",
            "kjh",
            "koy",
            "lag",
            "lkt",
            "lld",
            "mid",
            "mnc",
            "moe",
            "non",
            "nr",
            "nxm",
            "ood",
            "otk",
            "pjt",
            "ppu",
            "pwn",
            "pyu",
            "quc",
            "qya",
            "rar",
            "shy",
            "sia",
            "sjd",
            "sjk",
            "sjn",
            "sjt",
            "sju",
            "ssf",
            "syc",
            "tlb",
            "trv",
            "tzl",
            "uga",
            "umu",
            "uun",
            "xpu",
            "yap",
            "zun"));
}
